<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LeafletJS Map</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #map {
            height: 100vh;
            width: 100%;
        }
        .custom-control {
            background: white;
            padding: 5px;
            border-radius: 5px;
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.65);
        }
    </style>
</head>

<body>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // Initialize the map
        const map = L.map('map').setView([22.2795, 114.1694], 12); // Center of Hong Kong

        // Load a tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // Create a custom icon for user's current location
        const userLocationIcon = L.icon({
            iconUrl: 'https://img.icons8.com/?size=100&id=OZZ2pTwn45ie&format=png&color=000000',
            iconSize: [30, 30],
            iconAnchor: [15, 30],
            popupAnchor: [0, -30]
        });

        const speedEnhancementCameraIcon = L.icon({
            // iconUrl: 'https://img.icons8.com/?size=100&id=41273&format=png&color=000000',
            iconUrl: 'https://img.icons8.com/?size=100&id=lMK80N2QxxpY&format=png&color=000000',
            iconSize: [30, 30],
            iconAnchor: [15, 30],
            popupAnchor: [0, -30]
        });

        // Store user's location marker
        let userMarker;

        // Function to create a custom control for the timestamp
        const createTimestampControl = () => {
            const timestampControl = L.control({ position: 'topright' });

            timestampControl.onAdd = function () {
                this._div = L.DomUtil.create('div', 'custom-control');
                this.update();
                return this._div;
            };

            timestampControl.update = function (timestamp) {
                this._div.innerHTML = timestamp ? 
                    `<div class="fst-italic text-success"><b>最新更新時間日期：</b>${new Date(timestamp).toISOString().split('.')[0]}</div>` : 
                    '<div class="fst-italic text-secondary"><b>最新更新時間日期：</b>N/A</div>';
            };

            timestampControl.addTo(map);
            return timestampControl;
        };

        const timestampControl = createTimestampControl();

        // Function to fetch GeoJSON data
        const fetchGeoJsonData = () => {
            fetch('https://portal.csdi.gov.hk/server/services/common/td_rcd_1671693428549_89372/MapServer/WFSServer?service=wfs&request=GetFeature&typenames=points&outputFormat=geojson&maxFeatures=1000')
                .then(response => response.json())
                .then(data => {
                    // Update timestamp
                    const timestamp = Date.now();
                    timestampControl.update(timestamp);

                    // Add markers based on GeoJSON data
                    data.features.forEach(feature => {
                        const coordinates = feature.geometry.coordinates;
                        const popupInfo = feature.properties.PopupInfo;
                        const attrs = Array.from(popupInfo.matchAll(/<td>([^<]+)<\/td>/g)).map(e => e[1] !== undefined ? e[1] : e[2]).slice(1, 5 + 1);

                        // Create a marker for GeoJSON data
                        const marker = L.marker([coordinates[1], coordinates[0]], { icon: speedEnhancementCameraIcon }).addTo(map);
                        marker.bindPopup(`
                            <div class="d-flex flex-column" style="font-family:arial!important">
                                <div class="fst-italic text-success">創建日期： ${attrs[3].slice(0,4)}-${attrs[3].slice(4,6)}-${attrs[3].slice(6,8)}</div>
                                <div class="fst-italic text-success">更新日期： ${attrs[4].slice(0,4)}-${attrs[4].slice(4,6)}-${attrs[4].slice(6,8)}</div>
                                <hr class="w-100 my-3" />
                                <div>
                                    <div><b>位置：</b></div>
                                    <div>
                                        <ul>
                                            <li>${attrs[1]}</li>
                                            <li>${attrs[0]}</li>
                                            <li>${attrs[2]}</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        `);
                    });
                })
                .catch(err => console.error('Fetch error:', err));
        };

        // Fetch GeoJSON data initially
        fetchGeoJsonData();

        // Function to update the user's location
        const updateUserLocation = () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const userLat = position.coords.latitude;
                    const userLng = position.coords.longitude;

                    // Update marker position or add a new marker
                    if (userMarker) {
                        userMarker.setLatLng([userLat, userLng]);
                    } else {
                        userMarker = L.marker([userLat, userLng], { icon: userLocationIcon }).addTo(map);
                        timestampControl.update(Date.now());
                    }

                    // Optionally, set the map view to the user's location
                    map.setView([userLat, userLng], 14);
                }, function() {
                    alert('Unable to retrieve your location.');
                });
            } else {
                alert('Geolocation is not supported by this browser.');
            }
        };

        fetchGeoJsonData();

        // Update location every 10 seconds
        setInterval(updateUserLocation, 3*1000);
    </script>
</body>


</html>
